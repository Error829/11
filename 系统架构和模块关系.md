# 空间站环境监控系统运行机制与模块调用关系

## 1. 系统启动流程

### 1.1 初始化顺序

```
main()
├── SystemInit()                    // 系统初始化
    ├── InitSensors()              // 传感器初始化
    │   ├── DHT11Init()            // 温湿度传感器初始化
    │   ├── MQ2Init()              // 烟雾传感器初始化
    │   └── BH1750Init()           // 光照传感器初始化
    │
    ├── CollectorInit()            // 数据采集模块初始化
    │   ├── 创建数据缓存
    │   └── 创建采集定时器
    │
    ├── AlarmInit()                // 报警模块初始化
    │   ├── 初始化LED和蜂鸣器
    │   └── 创建报警记录缓存
    │
    └── InitAlarmRules()           // 初始化默认报警规则

└── SystemStart()                  // 启动系统
    ├── CollectorStart()           // 启动数据采集
    └── 启动报警检查定时器
```

### 1.2 启动过程说明

1. 系统初始化(SystemInit)
   - 首先初始化所有硬件设备
   - 创建必要的数据结构和缓存
   - 配置默认的系统参数
   - 初始化各功能模块

2. 系统启动(SystemStart)
   - 启动数据采集定时器
   - 启动报警检查定时器
   - 系统进入正常运行状态

## 2. 模块依赖关系

### 2.1 模块层级关系

```
services/
    └── 依赖 --> business/
                  └── 依赖 --> data/
                                └── 依赖 --> drivers/
```

### 2.2 具体依赖说明

1. 驱动层(drivers/)
   - 不依赖其他模块
   - 提供硬件抽象接口
   - 被上层模块调用

2. 数据层(data/)
   - 依赖驱动层获取传感器数据
   - 提供数据管理接口
   - 被业务层调用

3. 业务层(business/)
   - 依赖数据层获取环境数据
   - 依赖驱动层控制输出设备
   - 提供业务逻辑接口

4. 服务层(services/)
   - 依赖业务层实现功能
   - 提供对外服务接口

## 3. 数据流向

### 3.1 数据采集流向

```
传感器 --> 驱动层 --> 数据采集模块 --> 数据缓存
                                  └--> 触发回调通知
```

1. 传感器驱动读取原始数据
2. 数据采集模块处理数据
3. 更新数据缓存
4. 通知关注者(如报警模块)

### 3.2 报警处理流向

```
数据缓存 --> 报警检查 --> 报警触发 --> 输出设备
                               └--> 报警记录
```

1. 从数据缓存获取最新数据
2. 报警模块检查规则
3. 触发报警时控制输出设备
4. 保存报警记录

## 4. 事件处理机制

### 4.1 定时器事件

1. 数据采集定时器
   - 周期性触发数据采集
   - 调用传感器驱动读取数据
   - 更新数据缓存
   - 触发数据更新事件

2. 报警检查定时器
   - 周期性检查报警条件
   - 读取最新传感器数据
   - 执行报警规则检查
   - 触发报警事件

### 4.2 回调事件

1. 数据更新回调
   - 数据采集完成后触发
   - 通知关注者数据已更新
   - 可用于实时显示等功能

2. 报警回调
   - 报警触发时执行
   - 通知关注者处理报警
   - 可用于记录日志等功能

## 5. 核心调用链路

### 5.1 数据采集链路

```
CollectorTimer回调
└── CollectData()                  // 采集数据
    ├── DHT11GetData()            // 读取温湿度
    ├── MQ2GetData()              // 读取烟雾
    ├── BH1750GetData()           // 读取光照
    │
    ├── CacheData()               // 缓存数据
    └── 触发回调通知
```

### 5.2 报警处理链路

```
AlarmTimer回调
└── AlarmCheck()                   // 检查报警
    |── CollectorGetLatestData()   // 获取最新数据
    ├── CheckThreshold()           // 检查阈值
    │
    └── TriggerAlarm()            // 触发报警
        ├── LEDSetColor()         // 设置LED颜色
        ├── BuzzerStart()         // 启动蜂鸣器
        └── 保存报警记录
```

## 6. 状态管理

### 6.1 系统状态

系统状态机:
```
SYSTEM_STATE_INIT --> SYSTEM_STATE_RUNNING
                 \--> SYSTEM_STATE_ERROR
```

### 6.2 模块状态

1. 数据采集模块
   ```
   COLLECTOR_STATE_IDLE --> COLLECTOR_STATE_RUNNING
                       \--> COLLECTOR_STATE_ERROR
   ```

2. 报警模块
   ```
   ALARM_STATE_NORMAL --> ALARM_STATE_WARNING
                     \--> ALARM_STATE_CRITICAL
   ```

## 7. 总结

该系统采用分层设计,通过事件驱动的方式实现模块间的解耦。数据采集和报警处理是两个核心的处理链路,它们通过定时器触发运行,并通过回调机制实现模块间的通信。系统的状态管理确保了运行的可靠性,错误处理机制保障了系统的稳定性。 